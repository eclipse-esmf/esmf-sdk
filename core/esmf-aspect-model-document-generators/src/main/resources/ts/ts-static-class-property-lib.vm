#**
 ~ Copyright (c) 2021 Robert Bosch Manufacturing Solutions GmbH
 ~
 ~ See the AUTHORS file(s) distributed with this work for additional
 ~ information regarding authorship.
 ~
 ~ This Source Code Form is subject to the terms of the Mozilla Public
 ~ License, v. 2.0. If a copy of the MPL was not distributed with this
 ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
 ~
 ~ SPDX-License-Identifier: MPL-2.0
 *#

#macro( propertyDeclaration ) public static readonly #end

#macro( getCharacteristicClassName )
    $property.getEffectiveCharacteristic().get().getClass().getSimpleName()
#end


#* @vtlvariable name="characteristic" type="org.eclipse.esmf.metamodel.Characteristic" *#
#* @vtlvariable name="element" type="org.eclipse.esmf.metamodel.StructureElement" *#
#macro( propertyCharacteristic $element $property $characteristic $propertyTypeName )
    $characteristic.accept($modelVisitor, $context.withCurrentElement( $element ).withCurrentProperty( $property ) )
#end

#macro( tsStaticClassProperty $property $codeGenerationConfig $element )
    #set( $propertyType = $util.getPropertyType( $property, $codeGenerationConfig ) )
    #set( $containingClass = $util.generateClassName( $element, $codeGenerationConfig ) )

    ## public static readonly $property = (definition)
    #propertyDeclaration() $util.toConstant( $property.getName() ) = #staticProperty( $property $containingClass $codeGenerationConfig )

#end

## -------------------------------------------------

#macro( staticProperty $property $containingClass $codeGenerationConfig )
    #set( $propertyType = $util.getPropertyTypeAndAddImport( $property, $codeGenerationConfig ) )

    ## new (class extends $type <...> {
    #if( $Trait.isAssignableFrom( $property.getCharacteristic().get().getClass() ) )
        $codeGenerationConfig.importTracker().importExplicit( 'StaticConstraintProperty' , './core/staticConstraintProperty' )
        #if( $util.hasContainerType( $property ) )
            $codeGenerationConfig.importTracker().importExplicit( 'StaticConstraintContainerProperty' , './core/staticConstraintProperty'  )
            #set( $containedType = $util.getCharacteristicTsType( $property, $codeGenerationConfig ) )
        new (class extends StaticConstraintContainerProperty<$containingClass, $containedType, $propertyType, #getCharacteristicClassName()>{
        #elseif( $util.hasUnit( $property.getCharacteristic().get() ) )
            $codeGenerationConfig.importTracker().importExplicit( 'StaticConstraintUnitProperty' , './core/staticConstraintProperty'  )
            $codeGenerationConfig.importTracker().importExplicit( 'Unit' , './core/staticConstraintProperty'  )
        new (class extends StaticConstraintUnitProperty<$containingClass, $propertyType, #getCharacteristicClassName()>{
        #else
        new (class extends StaticConstraintProperty<$containingClass, $propertyType, #getCharacteristicClassName()>{
        #end
    #else
        #if( $util.hasContainerType( $property ) && !$propertyType.startsWith( "Map" ) )
            $codeGenerationConfig.importTracker().importExplicit( 'StaticContainerProperty' , './core/staticConstraintProperty'  )
            #set( $containedType = $util.getCharacteristicTsType( $property, $codeGenerationConfig ) )
        new (class extends StaticContainerProperty<$containingClass, $containedType, $propertyType> {
        #elseif( $util.hasUnit( $property.getCharacteristic().get() ) )
            $codeGenerationConfig.importTracker().importExplicit( 'StaticUnitProperty' , './core/staticConstraintProperty'  )
            $codeGenerationConfig.importTracker().importExplicit( 'Unit' , './core/staticConstraintProperty'  )
        new (class extends StaticUnitProperty<$containingClass, $propertyType>{
        #else
            $codeGenerationConfig.importTracker().importExplicit( 'DefaultStaticProperty' , './core/staticConstraintProperty'  )
        new (class extends DefaultStaticProperty<$containingClass, $propertyType>{
        #end
    #end

    ## Body })(
    #if( $Trait.isAssignableFrom( $property.getCharacteristic().get().getClass() ) )
    getConstraints(): Array
    <Constraint> {
        return this.characteristic.constraints;
        }
        getBaseCharacteristic(): DefaultCode {
        return this.characteristic.baseCharacteristic;
        }
    #end

    #set( $propertyType = $util.getPropertyType( $property, $codeGenerationConfig ) )
    getPropertyType(): string {
    #if( $util.hasContainerType( $property ) )
        return '${codeGenerationConfig.importTracker().getRawContainerType( $propertyType )}';
    #else
        #if( ${propertyType.contains( "Either" )} )
            return 'Either';
        #else
            return '${propertyType}';
        #end
    #end
    }

    getContainingType(): string {
    return '${containingClass}';
    }

    #if( $util.hasContainerType( $property ) && !$propertyType.startsWith( "Map" ) )
        getContainedType(): ${containingClass} {
        return '${containingClass}';
        }
    #end

    ##    TODO refactoring after Unit implementation in TS
    ##    #if( $util.hasUnit( $property.getCharacteristic().get() ) )
    ##        $codeGenerationConfig.importTracker().importExplicit( $Unit )
    ##        $codeGenerationConfig.importTracker().importExplicit( $Units )
    ##        public Unit getUnit() {
    ##        return Units.fromName("$util.castToQuantifiable( $property.getCharacteristic().get() ).unit.get().getName()")
    ##        .orElseThrow(() -> new RuntimeException("Unknown unit: $util.castToQuantifiable( $property.getCharacteristic().get() ).getUnit().get().getName()"));
    ##        }
    ##    #end
    })(
    {
    ## {$arg1, $arg2, ...});
    metaModelBaseAttributes : $modelVisitor.metaModelBaseAttributes( $property, $context ),
    characteristic : #propertyCharacteristic( $element, $property, $property.getCharacteristic().get(), $propertyType ),
    exampleValue : $modelVisitor.exampleValue( $property, $context ),
    optional : $property.isOptional(),
    notInPayload : $property.isNotInPayload(),
    #if ( '$property.getPayloadName()' != '' )
        payloadName : '$property.getPayloadName()',
    #end
    isAbstract : $property.isAbstract(),
    #if ( !$property.getExtends().isEmpty() )
        extends_ : #staticProperty( $property.getExtends().get(), $containingClass, $codeGenerationConfig )
    #end
    });

#end
